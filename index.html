/**
 * مسابقة توقعات كرة القدم — ملف واحد
 * تشغيل محلي:
 *   1) npm init -y
 *   2) npm i express sqlite3 bcrypt express-session
 *   3) ADMIN_KEY=secret node app.js
 * تصفح:
 *   - واجهة المتسابق:   http://localhost:3000
 *   - لوحة الإدارة:     http://localhost:3000/admin?key=secret
 *
 * ملاحظات:
 * - قاعدة البيانات SQLite في ملف data.db بجانب app.js (تُنشأ تلقائياً).
 * - كل الصفحات بالعربي، وCSS مدمج من خلال /style.css.
 * - موسم واحد بدورين (الأول/الثاني). من لوحة الإدارة تنشئ موسم وجولات ومباريات وتفعل الجولة الحالية.
 * - القوانين:
 *    نتيجة دقيقة = 4 / نفس فارق الأهداف = 2 / فائز صحيح = 1 / خطأ = 0
 *    دبل مباراة (مرة لكل جولة), ودبل جولة (مرة لكل دور)
 *    بونص: 4 صحيحة بالجولة +2، وكل صحيحة إضافية +1
 *    خصم: 4 خاطئة بالجولة -2، وكل خاطئة إضافية -1
 */

const express = require('express');
const session = require('express-session');
const bcrypt = require('bcrypt');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const ADMIN_KEY = process.env.ADMIN_KEY || 'secret';
const PORT = process.env.PORT || 3000;

const app = express();
app.use(express.urlencoded({ extended: true }));

// CSS مدمج
const CSS = `
*{box-sizing:border-box;font-family:system-ui, -apple-system, 'Segoe UI', Roboto, Arial}
body{margin:0;background:#0b1530;color:#fff}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#0d1b3d;border-bottom:1px solid #223}
header h1{margin:0;font-size:18px}
nav a, nav span{margin-inline:8px;color:#cfe1ff;text-decoration:none}
nav a:hover{text-decoration:underline}
main{max-width:1000px;margin:20px auto;padding:0 16px}
.card{background:#12204a;border:1px solid #1d2c5a;border-radius:10px;padding:16px;margin-bottom:16px}
h2,h3{margin-top:0}
table{width:100%;border-collapse:collapse;background:#0f1d43}
th, td{border-bottom:1px solid #1d2c5a;padding:8px;text-align:center}
th{background:#0b1736}
input, button, select{padding:8px 10px;border-radius:8px;border:1px solid #2b3f7a;background:#0c1a3c;color:#fff}
button{cursor:pointer}
button:hover{background:#0f2558}
.error{background:#5a0f0f;border:1px solid #7a1d1d;padding:8px;border-radius:8px;margin-bottom:8px}
.hint{font-size:12px;opacity:.8}
.form-grid{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
.narrow{width:70px}
footer{padding:10px;text-align:center;opacity:.6}
`;

// جلسات
app.use(session({
  secret: process.env.SESSION_SECRET || 'غير-آمن-غير-الإنتاج',
  resave: false,
  saveUninitialized: false
}));

// DB
const db = new sqlite3.Database(path.join(__dirname, 'data.db'));
db.serialize(() => {
  db.run(`CREATE TABLE IF NOT EXISTS users(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    pin_hash TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS seasons(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    is_active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS rounds(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    season_id INTEGER NOT NULL,
    leg INTEGER NOT NULL,            -- 1: الدور الأول، 2: الدور الثاني
    round_number INTEGER NOT NULL,   -- رقم الجولة داخل الدور
    is_active INTEGER DEFAULT 0,     -- الجولة الحالية
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(season_id, leg, round_number)
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS matches(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    season_id INTEGER NOT NULL,
    round_id INTEGER NOT NULL,
    home_team TEXT NOT NULL,
    away_team TEXT NOT NULL,
    kickoff_at DATETIME, -- "YYYY-MM-DD HH:MM"
    home_goals INTEGER,
    away_goals INTEGER
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS predictions(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    match_id INTEGER NOT NULL,
    home_goals INTEGER,
    away_goals INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, match_id)
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS double_matches(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    round_id INTEGER NOT NULL,
    match_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, round_id)
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS double_rounds(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    season_id INTEGER NOT NULL,
    leg INTEGER NOT NULL,        -- 1 أو 2
    round_id INTEGER NOT NULL,   -- الجولة المستخدمة
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, season_id, leg)
  )`);
});

// Helpers
const layout = (user, title, body) => `<!DOCTYPE html>
<html lang="ar" dir="rtl"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${title || 'مسابقة التوقعات'}</title><link rel="stylesheet" href="/style.css"/></head>
<body>
<header>
  <h1>مسابقة التوقعات</h1>
  <nav>
    <a href="/">الصفحة الرئيسية</a>
    <a href="/leaderboard">الترتيب</a>
    ${user ? `<a href="/me">لوحتي</a><span>مرحباً، <strong>${escapeHtml(user.username)}</strong></span><a href="/logout">خروج</a>` : `<a href="/login">دخول</a>`}
  </nav>
</header>
<main>${body}</main>
<footer><small>إصدار ملف واحد — جاهز للتطوير</small></footer>
</body></html>`;

const escapeHtml = (s='') => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function ensureAuth(req,res,next){ if(!req.session.user) return res.redirect('/login'); next(); }
function isAdmin(req){ return req.query.key && req.query.key === ADMIN_KEY; }
function outcome(h,a){ if(h==null||a==null) return null; if(h>a) return 'H'; if(h<a) return 'A'; return 'D'; }
function pointsForMatch(ph,pa,rh,ra){
  if(rh==null||ra==null) return 0;
  const prOut = outcome(ph,pa), rlOut = outcome(rh,ra);
  if(ph===rh && pa===ra) return 4;
  const pd = ph - pa, rd = rh - ra;
  if(prOut===rlOut && pd===rd) return 2;
  if(prOut===rlOut) return 1;
  return 0;
}
function getActiveSeason(cb){
  db.get(`SELECT * FROM seasons WHERE is_active=1 ORDER BY id DESC LIMIT 1`, (e,row)=> cb(row||null));
}
function getActiveRound(seasonId, cb){
  db.get(`SELECT * FROM rounds WHERE season_id=? AND is_active=1 LIMIT 1`, [seasonId], (e,row)=> cb(row||null));
}

// CSS route
app.get('/style.css', (req,res)=>{ res.type('text/css').send(CSS); });

// Auth
app.get('/login', (req,res)=>{
  const body = `
  <section class="card">
    <h2>دخول/تسجيل</h2>
    ${req.query.err? `<div class="error">${escapeHtml(req.query.err)}</div>`:''}
    <form method="POST" action="/login" class="form-grid">
      <label>اسم المستخدم</label><input name="username" required>
      <label>PIN (٤ أرقام)</label><input name="pin" type="password" pattern="\\d{4}" required>
      <button type="submit">دخول</button>
    </form>
  </section>`;
  res.send(layout(null,'تسجيل الدخول', body));
});
app.post('/login', (req,res)=>{
  let body='';
  req.on('data', chunk=> body+=chunk);
  req.on('end', async ()=>{
    const params = new URLSearchParams(body);
    const username = params.get('username');
    const pin = params.get('pin');
    if(!username || !pin){ return res.redirect('/login?err='+encodeURIComponent('أدخل الاسم و PIN')); }
    db.get(`SELECT * FROM users WHERE username=?`, [username], async (e,user)=>{
      if(e) return res.redirect('/login?err='+encodeURIComponent('خطأ قاعدة البيانات'));
      if(!user){
        const hash = await bcrypt.hash(pin,10);
        db.run(`INSERT INTO users(username, pin_hash) VALUES(?,?)`, [username, hash], function(err){
          if(err) return res.redirect('/login?err='+encodeURIComponent('خطأ إنشاء المستخدم'));
          req.session.user = { id:this.lastID, username };
          res.redirect('/');
        });
      } else {
        const ok = await bcrypt.compare(pin, user.pin_hash);
        if(!ok) return res.redirect('/login?err='+encodeURIComponent('PIN غير صحيح'));
        req.session.user = { id:user.id, username:user.username };
        res.redirect('/');
      }
    });
  });
});
app.get('/logout', (req,res)=> req.session.destroy(()=> res.redirect('/login')));

// Home: current round predictions
app.get('/', ensureAuth, (req,res)=>{
  getActiveSeason(season=>{
    if(!season) return res.send(layout(req.session.user,'لا يوجد موسم', `<section class="card"><p>لم يتم إنشاء موسم بعد. ادخل لوحة الإدارة.</p></section>`));
    getActiveRound(season.id, round=>{
      if(!round) return res.send(layout(req.session.user,'لا توجد جولة نشطة', `<section class="card"><p>لا توجد جولة نشطة حالياً.</p></section>`));
      db.all(`SELECT m.*, p.home_goals AS phg, p.away_goals AS pag
              FROM matches m LEFT JOIN predictions p ON p.match_id=m.id AND p.user_id=?
              WHERE m.round_id=? ORDER BY m.kickoff_at ASC, m.id ASC`,
        [req.session.user.id, round.id], (err, matches)=>{
          if(err) return res.send(layout(req.session.user,'خطأ', `<section class="card"><p>خطأ قاعدة البيانات</p></section>`));
          db.get(`SELECT * FROM double_matches WHERE user_id=? AND round_id=?`, [req.session.user.id, round.id], (e2, dm)=>{
            db.get(`SELECT * FROM double_rounds WHERE user_id=? AND season_id=? AND leg=?`, [req.session.user.id, season.id, round.leg], (e3, dr)=>{
              const rows = matches.map((m,idx)=>{
                const locked = m.kickoff_at && new Date(m.kickoff_at) <= new Date();
                return `<tr>
                  <td>${idx+1}</td>
                  <td><strong>${escapeHtml(m.home_team)}</strong> vs <strong>${escapeHtml(m.away_team)}</strong></td>
                  <td>${m.kickoff_at? new Date(m.kickoff_at).toLocaleString('ar-SA'):'-'}</td>
                  <td>
                    <input class="narrow" name="phg_${m.id}" type="number" min="0" value="${m.phg ?? ''}" ${locked?'disabled':''}> :
                    <input class="narrow" name="pag_${m.id}" type="number" min="0" value="${m.pag ?? ''}" ${locked?'disabled':''}>
                    ${locked? `<div class="hint">مقفلة</div>`:''}
                  </td>
                  <td><input type="radio" name="double_match" value="${m.id}" ${(dm && dm.match_id===m.id)?'checked':''} ${locked?'disabled':''}></td>
                  <td>${(m.home_goals!=null && m.away_goals!=null) ? `<strong>${m.home_goals} : ${m.away_goals}</strong>` : '-'}</td>
                </tr>`;
              }).join('');
              const drBox = (!dr) ? `<label><input type="checkbox" name="double_round"> استخدام دبل الجولة الآن (مرة واحدة في هذا الدور)</label>`
                   : (dr.round_id===round.id) ? `<p>استخدمت دبل الجولة في هذه الجولة.</p>`
                   : `<p>استخدمت دبل الجولة سابقاً في هذا الدور.</p>`;
              const body = `
              <section class="card">
                <h2>الجولة الحالية</h2>
                <p><strong>الموسم:</strong> ${escapeHtml(season.name)} — <strong>الدور:</strong> ${round.leg===1?'الأول':'الثاني'} — <strong>الجولة:</strong> ${round.round_number}</p>
                ${matches.length===0 ? '<p>لا توجد مباريات لهذه الجولة.</p>' : `
                <form method="POST" action="/predictions">
                  <table>
                    <thead><tr><th>#</th><th>المباراة</th><th>الوقت</th><th>توقعك</th><th>دبل المباراة</th><th>النتيجة</th></tr></thead>
                    <tbody>${rows}</tbody>
                  </table>
                  <div class="card"><h3>مضاعفة الجولة</h3>${drBox}</div>
                  <button type="submit">حفظ</button>
                </form>`}
              </section>
              <p class="hint">القوانين: نتيجة دقيقة ٤ / نفس فارق الأهداف ٢ / فائز صحيح ١ / خطأ ٠ — دبل المباراة يضاعف نقاطها فقط — دبل الجولة يضاعف إجمالي الجولة بعد البونص/الخصم.</p>`;
              res.send(layout(req.session.user, 'التوقعات', body));
            });
          });
      });
    });
  });
});

app.post('/predictions', ensureAuth, (req,res)=>{
  let body=''; req.on('data',c=> body+=c);
  req.on('end', ()=>{
    const params = new URLSearchParams(body);
    getActiveSeason(season=>{
      if(!season) return res.redirect('/');
      getActiveRound(season.id, round=>{
        if(!round) return res.redirect('/');
        db.all(`SELECT * FROM matches WHERE round_id=?`, [round.id], (err, ms)=>{
          if(err) return res.redirect('/');
          const now = Date.now();
          const earliest = ms.reduce((min, m)=>{
            const t = m.kickoff_at ? new Date(m.kickoff_at).getTime() : Infinity;
            return Math.min(min, t);
          }, Infinity);
          const firstKickoff = isFinite(earliest) ? earliest : null;

          const tasks = [];
          // توقعات
          ms.forEach(m=>{
            const ph = params.get(`phg_${m.id}`);
            const pa = params.get(`pag_${m.id}`);
            const ko = m.kickoff_at ? new Date(m.kickoff_at).getTime() : null;
            const locked = ko && ko<=now;
            if(ph!==null && pa!==null && ph!=='' && pa!=='' && !locked){
              tasks.push(new Promise((resolve,reject)=>{
                db.run(`INSERT INTO predictions(user_id, match_id, home_goals, away_goals)
                        VALUES(?,?,?,?)
                        ON CONFLICT(user_id, match_id) DO UPDATE SET home_goals=excluded.home_goals, away_goals=excluded.away_goals`,
                  [req.session.user.id, m.id, parseInt(ph,10), parseInt(pa,10)], e=> e?reject(e):resolve());
              }));
            }
          });
          // دبل مباراة
          const dmId = params.get('double_match');
          if(dmId){
            const target = ms.find(x=> String(x.id)===String(dmId));
            const locked = target && target.kickoff_at ? (new Date(target.kickoff_at).getTime()<=now) : false;
            if(target && !locked){
              tasks.push(new Promise((resolve,reject)=>{
                db.run(`INSERT INTO double_matches(user_id, round_id, match_id)
                        VALUES(?,?,?)
                        ON CONFLICT(user_id, round_id) DO UPDATE SET match_id=excluded.match_id`,
                  [req.session.user.id, round.id, parseInt(dmId,10)], e=> e?reject(e):resolve());
              }));
            }
          }
          // دبل الجولة
          const useDR = params.get('double_round')==='on';
          if(useDR){
            const roundLocked = firstKickoff && firstKickoff<=now;
            if(!roundLocked){
              tasks.push(new Promise((resolve,reject)=>{
                db.run(`INSERT INTO double_rounds(user_id, season_id, leg, round_id)
                        VALUES(?,?,?,?)
                        ON CONFLICT(user_id, season_id, leg) DO UPDATE SET round_id=excluded.round_id`,
                  [req.session.user.id, season.id, round.leg, round.id], e=> e?reject(e):resolve());
              }));
            }
          }
          Promise.all(tasks).then(()=> res.redirect('/')).catch(()=> res.redirect('/'));
        });
      });
    });
  });
});

// Leaderboard
app.get('/leaderboard', (req,res)=>{
  getActiveSeason(season=>{
    if(!season) return res.send(layout(req.session?.user,'ترتيب', `<section class="card"><p>لا يوجد موسم نشط.</p></section>`));
    db.all(`SELECT * FROM rounds WHERE season_id=? ORDER BY leg ASC, round_number ASC`, [season.id], (eR, rounds)=>{
      db.all(`SELECT * FROM matches WHERE season_id=?`, [season.id], (eM, matches)=>{
        db.all(`SELECT * FROM predictions`, (eP, preds)=>{
          db.all(`SELECT * FROM double_matches`, (eDM, dms)=>{
            db.all(`SELECT * FROM double_rounds WHERE season_id=?`, [season.id], (eDR, drs)=>{
              db.all(`SELECT id, username FROM users`, (eU, users)=>{
                const byMatch = {}; matches.forEach(m=> byMatch[m.id]=m);
                const predsByUser = {}; preds.forEach(p=> (predsByUser[p.user_id] ||= []).push(p));
                const dmByUserRound = {}; dms.forEach(x=> dmByUserRound[`${x.user_id}-${x.round_id}`]=x.match_id);
                const drByUserLeg = {}; drs.forEach(x=> drByUserLeg[`${x.user_id}-${x.leg}`]=x.round_id);

                function computeUserTotal(uid){
                  let total=0;
                  rounds.forEach(r=>{
                    const ms = matches.filter(m=> m.round_id===r.id && m.home_goals!=null && m.away_goals!=null);
                    if(ms.length===0) return;
                    const ups = (predsByUser[uid]||[]).filter(p=> byMatch[p.match_id] && byMatch[p.match_id].round_id===r.id);
                    let roundPoints=0, correct=0, wrong=0;
                    const dmId = dmByUserRound[`${uid}-${r.id}`] || null;
                    ms.forEach(m=>{
                      const pp = ups.find(p=> p.match_id===m.id);
                      if(!pp) return;
                      const base = pointsForMatch(pp.home_goals, pp.away_goals, m.home_goals, m.away_goals);
                      roundPoints += (dmId===m.id) ? base*2 : base;
                      if(base>=2) correct++;
                      if(base===0) wrong++;
                    });
                    if(correct>=4) roundPoints += 2 + (correct-4);
                    if(wrong>=4) roundPoints -= 2 + (wrong-4);
                    const drRoundId = drByUserLeg[`${uid}-${r.leg}`] || null;
                    if(drRoundId && drRoundId===r.id) roundPoints *= 2;
                    total += roundPoints;
                  });
                  return total;
                }

                const table = users.map(u=>({username:u.username, total:computeUserTotal(u.id)||0}))
                                   .sort((a,b)=> b.total-a.total);
                const rows = table.map((u,i)=> `<tr><td>${i+1}</td><td>${escapeHtml(u.username)}</td><td><strong>${u.total}</strong></td></tr>`).join('');
                const body = `<section class="card">
                  <h2>ترتيب المتسابقين — ${escapeHtml(season.name)}</h2>
                  <table><thead><tr><th>المركز</th><th>المتسابق</th><th>النقاط</th></tr></thead>
                  <tbody>${rows || `<tr><td colspan="3">لا يوجد بيانات بعد.</td></tr>`}</tbody></table>
                </section>`;
                res.send(layout(req.session?.user, 'الترتيب', body));
              });
            });
          });
        });
      });
    });
  });
});

// "لوحتي"
app.get('/me', ensureAuth, (req,res)=>{
  getActiveSeason(season=>{
    if(!season) return res.send(layout(req.session.user,'لوحتي', `<section class="card"><p>لا يوجد موسم نشط.</p></section>`));
    db.all(`SELECT * FROM rounds WHERE season_id=? ORDER BY leg ASC, round_number ASC`, [season.id], (eR, rounds)=>{
      db.all(`SELECT * FROM matches WHERE season_id=?`, [season.id], (eM, matches)=>{
        db.all(`SELECT * FROM predictions WHERE user_id=?`, [req.session.user.id], (eP, preds)=>{
          db.all(`SELECT * FROM double_matches WHERE user_id=?`, [req.session.user.id], (eDM, dms)=>{
            db.all(`SELECT * FROM double_rounds WHERE user_id=? AND season_id=?`, [req.session.user.id, season.id], (eDR, drs)=>{
              const dmByRound={}; dms.forEach(x=> dmByRound[x.round_id]=x.match_id);
              const drByLeg={}; drs.forEach(x=> drByLeg[x.leg]=x.round_id);

              function calcRound(r){
                const ms = matches.filter(m=> m.round_id===r.id && m.home_goals!=null && m.away_goals!=null);
                const ups = preds.filter(p=> ms.some(m=> m.id===p.match_id));
                const dmId = dmByRound[r.id] || null;
                let sum=0, correct=0, wrong=0;
                ms.forEach(m=>{
                  const pp = ups.find(p=> p.match_id===m.id);
                  const base = pp? pointsForMatch(pp.home_goals, pp.away_goals, m.home_goals, m.away_goals):0;
                  sum += (dmId===m.id)? base*2: base;
                  if(base>=2) correct++;
                  if(base===0) wrong++;
                });
                let bonus=0, penalty=0;
                if(correct>=4) bonus = 2 + (correct-4);
                if(wrong>=4) penalty = 2 + (wrong-4);
                let total = sum + bonus - penalty;
                const usedDR = drByLeg[r.leg]===r.id;
                if(usedDR) total *= 2;
                return {correct, wrong, bonus, penalty, total};
              }

              const rows = rounds.map(r=>{
                const x = calcRound(r);
                return `<tr>
                  <td>${r.leg===1?'الأول':'الثاني'}</td>
                  <td>${r.round_number}</td>
                  <td>${x.correct}</td>
                  <td>${x.wrong}</td>
                  <td>${x.bonus}</td>
                  <td>${x.penalty}</td>
                  <td>${drByLeg[r.leg]===r.id? 'نعم':'لا'}</td>
                  <td><strong>${x.total}</strong></td>
                </tr>`;
              }).join('');
              const seasonTotal = rounds.reduce((a,r)=> a + calcRound(r).total, 0);
              const body = `<section class="card">
                <h2>تفاصيل نقاطي</h2>
                <p><strong>الموسم:</strong> ${escapeHtml(season.name)}</p>
                <table>
                  <thead><tr><th>الدور</th><th>الجولة</th><th>صحيحة (2/4)</th><th>خاطئة (0)</th><th>بونص</th><th>خصم</th><th>دبل الجولة</th><th>المجموع</th></tr></thead>
                  <tbody>${rows}</tbody>
                  <tfoot><tr><td colspan="7" style="text-align:right">مجموع الموسم</td><td><strong>${seasonTotal}</strong></td></tr></tfoot>
                </table>
              </section>`;
              res.send(layout(req.session.user, 'لوحتي', body));
            });
          });
        });
      });
    });
  });
});

// Admin
app.get('/admin', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('ممنوع. أضف ?key=ADMIN_KEY');
  db.all(`SELECT * FROM seasons ORDER BY id DESC`, (eS, seasons)=>{
    const active = (seasons.find(s=>s.is_active===1) || seasons[0] || null);
    const sid = active? active.id : null;
    if(!sid){
      const body = `<section class="card">
        <h2>إدارة الموسم</h2>
        <form method="POST" action="/admin/create-season?key=${encodeURIComponent(req.query.key)}" class="form-grid">
          <label>اسم الموسم</label><input name="name" placeholder="موسم 2025"><button>إنشاء موسم وجعله نشط</button>
        </form>
      </section>`;
      return res.send(layout(null,'لوحة الإدارة', body));
    }
    db.all(`SELECT * FROM rounds WHERE season_id=? ORDER BY leg ASC, round_number ASC`, [sid], (eR, rounds)=>{
      db.all(`SELECT * FROM matches WHERE season_id=? ORDER BY round_id ASC, kickoff_at ASC`, [sid], (eM, matches)=>{
        const seasonSelect = `<form method="POST" action="/admin/set-active-season?key=${encodeURIComponent(req.query.key)}" class="form-grid">
          <label>الموسم النشط</label>
          <select name="season_id">
            ${seasons.map(s=> `<option value="${s.id}" ${s.id===sid?'selected':''}>${escapeHtml(s.name)} ${s.is_active?'(نشط)':''}</option>`).join('')}
          </select>
          <button>تعيين كالنشط</button>
        </form>`;

        const createRound = `<form method="POST" action="/admin/create-round?key=${encodeURIComponent(req.query.key)}" class="form-grid">
          <input type="hidden" name="season_id" value="${sid}">
          <label>الدور</label>
          <select name="leg"><option value="1">الأول</option><option value="2">الثاني</option></select>
          <label>رقم الجولة</label><input type="number" name="round_number" min="1" value="1">
          <button>إضافة جولة</button>
        </form>`;

        const roundsTable = `<table>
          <thead><tr><th>ID</th><th>الدور</th><th>الجولة</th><th>نشطة؟</th><th>اجعلها نشطة</th></tr></thead>
          <tbody>
          ${rounds.map(r=> `<tr>
            <td>${r.id}</td><td>${r.leg===1?'الأول':'الثاني'}</td><td>${r.round_number}</td><td>${r.is_active?'نعم':'لا'}</td>
            <td>
              <form method="POST" action="/admin/set-active-round?key=${encodeURIComponent(req.query.key)}">
                <input type="hidden" name="season_id" value="${sid}">
                <input type="hidden" name="round_id" value="${r.id}">
                <button>تفعيل</button>
              </form>
            </td></tr>`).join('')}
          </tbody>
        </table>`;

        const addMatch = `<form method="POST" action="/admin/add-match?key=${encodeURIComponent(req.query.key)}" class="form-grid">
          <label>الجولة</label>
          <select name="round_id">
            ${rounds.map(r=> `<option value="${r.id}">دور ${r.leg===1?'الأول':'الثاني'} — جولة ${r.round_number}</option>`).join('')}
          </select>
          <input type="hidden" name="season_id" value="${sid}">
          <label>المستضيف</label><input name="home_team" required>
          <label>الضيف</label><input name="away_team" required>
          <label>وقت البداية</label><input name="kickoff_at" placeholder="YYYY-MM-DD HH:MM">
          <button>إضافة مباراة</button>
        </form>`;

        const matchesTable = `<table>
          <thead><tr><th>ID</th><th>الجولة</th><th>المباراة</th><th>الوقت</th><th>النتيجة</th><th>تحديث</th></tr></thead>
          <tbody>
            ${matches.map(m=>{
              const r = rounds.find(x=> x.id===m.round_id);
              return `<tr>
                <td>${m.id}</td>
                <td>${r? ((r.leg===1?'الأول':'الثاني')+' — '+r.round_number): '-'}</td>
                <td>${escapeHtml(m.home_team)} vs ${escapeHtml(m.away_team)}</td>
                <td>${m.kickoff_at || '-'}</td>
                <td>${(m.home_goals!=null && m.away_goals!=null)? `${m.home_goals} : ${m.away_goals}`:'-'}</td>
                <td>
                  <form method="POST" action="/admin/set-result?key=${encodeURIComponent(req.query.key)}">
                    <input type="hidden" name="match_id" value="${m.id}">
                    <input class="narrow" type="number" name="home_goals" min="0" required> :
                    <input class="narrow" type="number" name="away_goals" min="0" required>
                    <button>حفظ</button>
                  </form>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;

        const body = `
        <section class="card">
          <h2>إدارة الموسم</h2>
          <form method="POST" action="/admin/create-season?key=${encodeURIComponent(req.query.key)}" class="form-grid">
            <label>اسم الموسم</label><input name="name" placeholder="موسم 2025">
            <button>إنشاء موسم وجعله نشط</button>
          </form>
          ${seasonSelect}
        </section>
        <section class="card"><h2>الجولات</h2>${createRound}<h3>كل الجولات</h3>${roundsTable}</section>
        <section class="card"><h2>المباريات</h2>${addMatch}<h3>قائمة المباريات</h3>${matchesTable}</section>`;
        res.send(layout(null,'لوحة الإدارة', body));
      });
    });
  });
});

app.post('/admin/create-season', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const name = new URLSearchParams(body).get('name');
    if(!name) return res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY));
    db.serialize(()=>{ db.run(`UPDATE seasons SET is_active=0`); db.run(`INSERT INTO seasons(name,is_active) VALUES(?,1)`, [name], ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY))); });
  });
});
app.post('/admin/set-active-season', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const id = parseInt(new URLSearchParams(body).get('season_id'),10);
    db.serialize(()=>{ db.run(`UPDATE seasons SET is_active=0`); db.run(`UPDATE seasons SET is_active=1 WHERE id=?`, [id], ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY))); });
  });
});
app.post('/admin/create-round', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const p = new URLSearchParams(body);
    db.run(`INSERT INTO rounds(season_id, leg, round_number) VALUES(?,?,?)`,
      [parseInt(p.get('season_id'),10), parseInt(p.get('leg'),10), parseInt(p.get('round_number'),10)],
      ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY)));
  });
});
app.post('/admin/set-active-round', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const p = new URLSearchParams(body);
    const sid = parseInt(p.get('season_id'),10);
    const rid = parseInt(p.get('round_id'),10);
    db.serialize(()=>{ db.run(`UPDATE rounds SET is_active=0 WHERE season_id=?`, [sid]); db.run(`UPDATE rounds SET is_active=1 WHERE id=?`, [rid], ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY))); });
  });
});
app.post('/admin/add-match', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const p = new URLSearchParams(body);
    db.run(`INSERT INTO matches(season_id, round_id, home_team, away_team, kickoff_at) VALUES(?,?,?,?,?)`,
      [parseInt(p.get('season_id'),10), parseInt(p.get('round_id'),10), p.get('home_team'), p.get('away_team'), p.get('kickoff_at') || null],
      ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY)));
  });
});
app.post('/admin/set-result', (req,res)=>{
  if(!isAdmin(req)) return res.status(403).send('Forbidden');
  let body=''; req.on('data',c=> body+=c); req.on('end', ()=>{
    const p = new URLSearchParams(body);
    db.run(`UPDATE matches SET home_goals=?, away_goals=? WHERE id=?`,
      [parseInt(p.get('home_goals'),10), parseInt(p.get('away_goals'),10), parseInt(p.get('match_id'),10)],
      ()=> res.redirect('/admin?key='+encodeURIComponent(ADMIN_KEY)));
  });
});

app.listen(PORT, ()=> console.log(`خادم يعمل على http://localhost:${PORT}`));
